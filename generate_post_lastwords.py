import os
import sys
from openai import OpenAI
from tweet_bot import tweet_post  # âœ… ã“ã“è¿½åŠ 

# âœ… APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# âœ… ãƒãƒã‚¡åŠæ§‹æ–‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå®Œå…¨å†ç¾ï¼‰
jp_prompt = """
è€å¥³äºŒäººã«ã‚ˆã‚‹ä¸‰è¡Œã®ä¼šè©±ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

å„è¡Œã¯ã€å‰ã®ç™ºè¨€ã«â€œå¿œç­”ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹â€å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€æ„å‘³å†…å®¹ã¯å¾®å¦™ã«ãšã‚Œã¦ã„ã¦ãã ã•ã„ã€‚
å¿œç­”ã®ã‚ˆã†ã«è¦‹ã›ã‹ã‘ãªãŒã‚‰ã€èªè­˜ã®ã™ã‚Œé•ã„ã‚„æ¯”å–©çš„ãªè„±ç·šãŒèµ·ã“ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ä¼šè©±ã¯ã€ã‹ã‚ã†ã˜ã¦æ•´åˆã—ã¦ã„ã‚‹ã‚ˆã†ã«æŒ¯ã‚‹èˆã„ãªãŒã‚‰ã€é™ã‹ã«ãã®ä¸€è²«æ€§ãŒå´©ã‚Œã¦ã„ãã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚
å®Œå…¨ã«æ„å‘³ä¸æ˜ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚è©©çš„ã§æ§‹é€ ãŒå£Šã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¦ã‚‚ã€æ„å›³çš„ãªä¼šè©±å½¢å¼ã§ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚

æ„Ÿå‚·çš„ãƒ»æŠ½è±¡çš„ãªå˜èªï¼ˆæ„›ãƒ»å¸Œæœ›ãƒ»è¨˜æ†¶ãƒ»é­‚ãªã©ï¼‰ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
åå‰ãƒ»è©±è€…è¨˜å·ã¯ä½¿ã‚ãšã€æ—¥æœ¬èªã®ä¼šè©±æ–‡ã®ã‚ˆã†ã«ã€Œã€ã§å§‹ã¾ã‚‹3è¡Œã§æ›¸ã„ã¦ãã ã•ã„ã€‚
ãã‚Œãã‚Œã®è¡Œã¯ã€ç‹¬ç«‹ã—ãŸæ¯”å–©ã‚„å°è±¡ã‚’æŒã¡ã¤ã¤ã€ä¼šè©±å…¨ä½“ãŒâ€œå¹½éœŠåŒå£«ã®èª¤è§£â€ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
ã€Œæ˜¨æ—¥ã€ç´å±‹ã§èµ¤ã‚“åŠã¿ãŸã„ãªéŸ³ã‚’èã„ãŸã®ã€
ã€Œã†ã¡ã‚‚ã€éšæ®µã®å½±ãŒæ™‚ã€…å–‹ã‚‹ã£ã¦è¨€ã£ã¦ãŸã‚ã€
ã€Œã§ã‚‚é´ã ã‘ã¯ã€ã‚‚ã†èª°ã«ã‚‚å±¥ã‹ã›ãªã„ã‚“ã ã£ã¦ã€
"""

# âœ… ãƒãƒã‚¡ä¼šè©±ç”Ÿæˆé–¢æ•°ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç›´æµã—ï¼‰
def generate_babaa_post(trigger_text: str = "") -> str:
    res = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": jp_prompt.strip()}],
        temperature=1.3,
    )
    return res.choices[0].message.content.strip()

# âœ… ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆGitHub Actionsã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
if __name__ == "__main__":
    repo = sys.argv[1] if len(sys.argv) > 1 else "Last-Words-Archive"
    trigger = sys.argv[2] if len(sys.argv) > 2 else "default"

    print(f"ğŸ§™â€â™€ï¸ Triggered by {repo} with event '{trigger}'")
    result = generate_babaa_post()
    print("ğŸ“ Generated Babaa Post:\n")
    print(result)

    # ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    os.makedirs("output", exist_ok=True)
    with open("output/babaa_generated.txt", "w", encoding="utf-8") as f:
        f.write(result)

    # âœ… æŠ•ç¨¿ï¼ˆTweetï¼‰å®Ÿè¡Œ
    tweet_post(result)
